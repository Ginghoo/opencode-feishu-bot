# é£ä¹¦å¡ç‰‡ JSON 2.0 é‡è®¾è®¡æ–¹æ¡ˆ

## æ ¸å¿ƒæ”¹è¿›

åŸºäºé£ä¹¦å¡ç‰‡ JSON 2.0 ç»„ä»¶ï¼Œåˆ©ç”¨ï¼š
- **`collapsible_panel`** - æŠ˜å é¢æ¿ï¼ŒæŠ˜å æ€è€ƒå†…å®¹
- **`markdown`** - å¯Œæ–‡æœ¬ï¼Œä¸»å“åº”å†…å®¹
- **`column_set`** - åˆ†æ å¸ƒå±€ï¼Œå·¥å…·è°ƒç”¨çŠ¶æ€
- **`note`** - å¤‡æ³¨ï¼Œåº•éƒ¨å…ƒä¿¡æ¯

---

## å¡ç‰‡ç»“æ„è®¾è®¡

```json
{
  "schema": "2.0",
  "header": {
    "title": { "tag": "plain_text", "content": "å¤„ç†ä¸­..." },
    "template": "wathet"
  },
  "body": {
    "elements": [
      // 1. ä¸»å“åº”å†…å®¹ (markdown)
      {
        "tag": "markdown",
        "content": "AI çš„æ–‡å­—å›å¤..."
      },
      
      // 2. æ€è€ƒè¿‡ç¨‹ (collapsible_panel) - é»˜è®¤æŠ˜å 
      {
        "tag": "collapsible_panel",
        "expanded": false,
        "header": {
          "title": {
            "tag": "plain_text",
            "content": "ğŸ’­ æ€è€ƒè¿‡ç¨‹"
          }
        },
        "elements": [
          {
            "tag": "markdown",
            "content": "```\næ€è€ƒå†…å®¹...\n```"
          }
        ]
      },
      
      // 3. å·¥å…·è°ƒç”¨ (column_set + markdown)
      {
        "tag": "column_set",
        "columns": [
          {
            "tag": "column",
            "width": "weighted",
            "weight": 1,
            "elements": [
              {
                "tag": "markdown",
                "content": "**âœ… read_file** `src/index.ts`"
              }
            ]
          }
        ]
      }
    ]
  }
}
```

---

## å„éƒ¨åˆ†è¯¦ç»†è®¾è®¡

### 1. ä¸»å“åº” (Text Parts)

ç›´æ¥ä½¿ç”¨ `markdown` ç»„ä»¶æ¸²æŸ“ AI çš„æ–‡å­—å›å¤ï¼š

```json
{
  "tag": "markdown",
  "content": "è¿™æ˜¯ AI çš„å›å¤ï¼Œæ”¯æŒ **ç²—ä½“**ã€`ä»£ç `ã€\n```javascript\nconsole.log('ä»£ç å—');\n```"
}
```

### 2. æ€è€ƒè¿‡ç¨‹ (Reasoning Parts)

ä½¿ç”¨ `collapsible_panel` æŠ˜å é¢æ¿ï¼Œé»˜è®¤æŠ˜å ï¼š

```json
{
  "tag": "collapsible_panel",
  "expanded": false,
  "header": {
    "title": {
      "tag": "plain_text", 
      "content": "ğŸ’­ æ€è€ƒè¿‡ç¨‹ (ç‚¹å‡»å±•å¼€)"
    }
  },
  "elements": [
    {
      "tag": "markdown",
      "content": "```\nç”¨æˆ·éœ€è¦å®ç°ç™»å½•åŠŸèƒ½...\nè€ƒè™‘ä½¿ç”¨ JWT...\n```"
    }
  ]
}
```

**ä¼˜ç‚¹ï¼š**
- é»˜è®¤æŠ˜å ï¼Œä¸å¹²æ‰°ä¸»å†…å®¹é˜…è¯»
- ç”¨æˆ·æ„Ÿå…´è¶£å¯ç‚¹å‡»å±•å¼€
- ä½¿ç”¨ä»£ç å—åŒ…è£¹ï¼Œé¿å…æ ¼å¼å†²çª

### 3. å·¥å…·è°ƒç”¨ (Tool Parts)

ä½¿ç”¨ `markdown` æ˜¾ç¤ºå·¥å…·çŠ¶æ€ï¼Œå•è¡Œç´§å‡‘æ ¼å¼ï¼š

```json
{
  "tag": "markdown",
  "content": "---\n**â³ read_file** è¯»å– `src/index.ts`\n**âœ… edit_file** ä¿®æ”¹å®Œæˆ (15 è¡Œ)\n**âŒ bash** æ‰§è¡Œå¤±è´¥"
}
```

å·¥å…·çŠ¶æ€ emojiï¼š
- â³ pending/running
- âœ… completed
- âŒ error

---

## è¿‡æ»¤é€»è¾‘

åªå¤„ç† assistant æ¶ˆæ¯çš„ partsï¼Œè¿‡æ»¤æ‰ï¼š
- `synthetic: true` - åˆæˆçš„ç”¨æˆ·è¾“å…¥å›æ˜¾
- `ignored: true` - è¢«å¿½ç•¥çš„ parts
- é `text/reasoning/tool` ç±»å‹

```typescript
function shouldIncludePart(part: Part): boolean {
  if (part.synthetic === true) return false;
  if (part.ignored === true) return false;
  return ['text', 'reasoning', 'tool'].includes(part.type);
}
```

---

## å®ç°æ–¹æ¡ˆ

### formatter.ts æ”¹åŠ¨

```typescript
// æ–°å¢ï¼šæ„å»ºå¡ç‰‡ body elements
function buildCardElements(state: CardState): CardElement[] {
  const elements: CardElement[] = [];
  
  // 1. ä¸»å“åº”å†…å®¹
  if (state.textContent) {
    elements.push({
      tag: 'markdown',
      content: truncate(state.textContent, 3000)
    });
  }
  
  // 2. æ€è€ƒè¿‡ç¨‹ï¼ˆæŠ˜å é¢æ¿ï¼‰
  if (state.reasoningContent) {
    elements.push({
      tag: 'collapsible_panel',
      expanded: false,
      header: {
        title: { tag: 'plain_text', content: 'ğŸ’­ æ€è€ƒè¿‡ç¨‹' }
      },
      elements: [{
        tag: 'markdown',
        content: '```\n' + truncate(state.reasoningContent, 1000) + '\n```'
      }]
    });
  }
  
  // 3. å·¥å…·è°ƒç”¨
  if (state.toolCalls.length > 0) {
    const toolLines = state.toolCalls.map(formatToolLine).join('\n');
    elements.push({
      tag: 'markdown',
      content: '---\n' + toolLines
    });
  }
  
  return elements;
}

function formatToolLine(tool: ToolState): string {
  const emoji = getStatusEmoji(tool.status);
  const title = tool.title || tool.name;
  return `**${emoji} ${tool.name}** ${title}`;
}
```

### manager.ts æ”¹åŠ¨

```typescript
interface CardState {
  textContent: string;
  reasoningContent: string;
  toolCalls: ToolState[];
}

// åˆ†ç±»å­˜å‚¨ä¸åŒç±»å‹çš„ parts
private updateCardState(part: Part): void {
  if (!shouldIncludePart(part)) return;
  
  switch (part.type) {
    case 'text':
      this.state.textContent += part.text;
      break;
    case 'reasoning':
      this.state.reasoningContent += part.text;
      break;
    case 'tool':
      this.updateToolState(part);
      break;
  }
}
```

---

## å¡ç‰‡æ•ˆæœé¢„è§ˆ

### ç®€å•æ–‡æœ¬å“åº”
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å“åº”å®Œæˆ                              [green] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                             â”‚
â”‚ æ ¹æ®ä½ çš„éœ€æ±‚ï¼Œæˆ‘å»ºè®®ä½¿ç”¨ JWT æ–¹æ¡ˆã€‚          â”‚
â”‚                                             â”‚
â”‚ ```javascript                               â”‚
â”‚ const token = jwt.sign(payload, secret);    â”‚
â”‚ ```                                         â”‚
â”‚                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### åŒ…å«æ€è€ƒçš„å“åº”
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å“åº”å®Œæˆ                              [green] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                             â”‚
â”‚ å»ºè®®é‡‡ç”¨æ–¹æ¡ˆ Aï¼Œæ€§èƒ½æ›´å¥½ã€‚                   â”‚
â”‚                                             â”‚
â”‚ â–¶ ğŸ’­ æ€è€ƒè¿‡ç¨‹ (ç‚¹å‡»å±•å¼€)                    â”‚
â”‚                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å±•å¼€åï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å“åº”å®Œæˆ                              [green] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                             â”‚
â”‚ å»ºè®®é‡‡ç”¨æ–¹æ¡ˆ Aï¼Œæ€§èƒ½æ›´å¥½ã€‚                   â”‚
â”‚                                             â”‚
â”‚ â–¼ ğŸ’­ æ€è€ƒè¿‡ç¨‹                               â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ ç”¨æˆ·éœ€è¦åœ¨ A å’Œ B ä¹‹é—´é€‰æ‹©...            â”‚ â”‚
â”‚ â”‚ A çš„ä¼˜ç‚¹æ˜¯æ€§èƒ½å¥½...                      â”‚ â”‚
â”‚ â”‚ B çš„ä¼˜ç‚¹æ˜¯ç®€å•...                        â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### åŒ…å«å·¥å…·è°ƒç”¨çš„å“åº”
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å¤„ç†ä¸­...                            [wathet] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                             â”‚
â”‚ æ­£åœ¨ä¿®æ”¹æ–‡ä»¶...                             â”‚
â”‚                                             â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚ **âœ… read_file** è¯»å– src/index.ts          â”‚
â”‚ **â³ edit_file** ä¿®æ”¹æ–‡ä»¶ä¸­...               â”‚
â”‚                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æˆªæ–­ç­–ç•¥

| å†…å®¹ç±»å‹ | æœ€å¤§é•¿åº¦ | æˆªæ–­æç¤º |
|---------|---------|---------|
| ä¸»å“åº” | 3000 å­—ç¬¦ | `... (å†…å®¹å·²æˆªæ–­)` |
| æ€è€ƒå†…å®¹ | 1000 å­—ç¬¦ | `... (å·²æˆªæ–­)` |
| å·¥å…·è¾“å‡º | ä¸æ˜¾ç¤ºè¯¦æƒ… | ä»…æ˜¾ç¤ºçŠ¶æ€è¡Œ |

---

## å®¢æˆ·ç«¯å…¼å®¹æ€§

- å¡ç‰‡ JSON 2.0 éœ€è¦é£ä¹¦å®¢æˆ·ç«¯ 7.20+
- ä½ç‰ˆæœ¬å®¢æˆ·ç«¯æ˜¾ç¤ºå‡çº§æç¤ºæ–‡æ¡ˆ
- `collapsible_panel` ä¸æ”¯æŒæ­å»ºå·¥å…·ï¼Œä»…æ”¯æŒ JSON æ„å»º

---

## å®æ–½æ­¥éª¤

1. æ›´æ–° `formatter.ts` ç±»å‹å®šä¹‰ï¼Œæ–°å¢ collapsible_panel
2. é‡å†™ `buildStreamingCard` ä½¿ç”¨æ–°çš„ elements ç»“æ„
3. æ›´æ–° `manager.ts` åˆ†ç±»å­˜å‚¨ parts å¹¶è¿‡æ»¤
4. æ›´æ–°æµ‹è¯•ç”¨ä¾‹
5. ç«¯åˆ°ç«¯æµ‹è¯•éªŒè¯

è¯·ç¡®è®¤è®¾è®¡æ–¹æ¡ˆåå¼€å§‹å®ç°ã€‚
